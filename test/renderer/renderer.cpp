#include "../test_utils.h"

#include <boost/iostreams/filter/zlib.hpp>
#include <gtest/gtest.h>

using namespace plaxel;
using namespace plaxel::test;

class RendererTest : public ::testing::Test {
protected:
  TestRenderer renderer;
  void SetUp() override {
  }
  void TearDown() override {
    if (SHOW_WINDOW) {
      while (!renderer.shouldClose()) {
        renderer.draw();
      }
      renderer.closeWindow();
    }
  }
};

TEST_F(RendererTest, SimpleDrawing) {
  // Arrange
  const auto testName = "simple_drawing_test";

  // Act
  drawAndSaveScreenshot(testName);

  // Assert
  EXPECT_EQ(compareImages(testName), 0);
}

TEST_F(RendererTest, OneCube) {
  // Arrange
  renderer.setVoxelTreeNode({1});

  // Act
  const auto data = drawAndGetTriangles(renderer);

  // Assert
  const std::string expected =
      "{1;0;0(0;1),0;0;0(1;1),0;1;0(1;0)}, {0;1;0(1;0),1;1;0(0;0),1;0;0(0;1)}, "
      "{0;0;1(0;1),1;0;1(1;1),1;1;1(1;0)}, {1;1;1(1;0),0;1;1(0;0),0;0;1(0;1)}, "
      "{0;0;0(0;1),0;0;1(1;1),0;1;1(1;0)}, {0;1;1(1;0),0;1;0(0;0),0;0;0(0;1)}, "
      "{1;0;1(0;1),1;0;0(1;1),1;1;0(1;0)}, {1;1;0(1;0),1;1;1(0;0),1;0;1(0;1)}, "
      "{0;0;1(0;1),0;0;0(1;1),1;0;0(1;0)}, {1;0;0(1;0),1;0;1(0;0),0;0;1(0;1)}, "
      "{0;1;0(0;1),0;1;1(1;1),1;1;1(1;0)}, {1;1;1(1;0),1;1;0(0;0),0;1;0(0;1)}";
  EXPECT_EQ(toString(data), expected);
}

TEST_F(RendererTest, TwoCubes) {
  // Arrange
  renderer.setVoxelTreeNode({1, 1});

  // Act
  const auto data = drawAndGetTriangles(renderer);

  // Assert
  const std::string expected =
      "{1;0;0(0;1),0;0;0(1;1),0;1;0(1;0)}, {0;1;0(1;0),1;1;0(0;0),1;0;0(0;1)}, "
      "{0;0;1(0;1),1;0;1(1;1),1;1;1(1;0)}, {1;1;1(1;0),0;1;1(0;0),0;0;1(0;1)}, "
      "{0;0;0(0;1),0;0;1(1;1),0;1;1(1;0)}, {0;1;1(1;0),0;1;0(0;0),0;0;0(0;1)}, "
      "{0;0;1(0;1),0;0;0(1;1),1;0;0(1;0)}, {1;0;0(1;0),1;0;1(0;0),0;0;1(0;1)}, "
      "{0;1;0(0;1),0;1;1(1;1),1;1;1(1;0)}, {1;1;1(1;0),1;1;0(0;0),0;1;0(0;1)}, "

      "{2;0;0(0;1),1;0;0(1;1),1;1;0(1;0)}, {1;1;0(1;0),2;1;0(0;0),2;0;0(0;1)}, "
      "{1;0;1(0;1),2;0;1(1;1),2;1;1(1;0)}, {2;1;1(1;0),1;1;1(0;0),1;0;1(0;1)}, "
      "{2;0;1(0;1),2;0;0(1;1),2;1;0(1;0)}, {2;1;0(1;0),2;1;1(0;0),2;0;1(0;1)}, "
      "{1;0;1(0;1),1;0;0(1;1),2;0;0(1;0)}, {2;0;0(1;0),2;0;1(0;0),1;0;1(0;1)}, "
      "{1;1;0(0;1),1;1;1(1;1),2;1;1(1;0)}, {2;1;1(1;0),2;1;0(0;0),1;1;0(0;1)}";
  EXPECT_EQ(toString(data), expected);
}

TEST_F(RendererTest, OneBigCube) {
  // Arrange
  VoxelTreeNode node = {};
  for (int x = 0; x < 2; ++x) {
    for (int y = 0; y < 2; ++y) {
      for (int z = 0; z < 2; ++z) {
        node.blocks[x + BLOCK_W * y + BLOCK_W * BLOCK_W * z] = 1;
      }
    }
  }
  renderer.setVoxelTreeNode(node);

  // Act
  const auto data = drawAndGetTriangles(renderer);

  // Assert
  const std::string expected =
      "{1;0;0(0;1),0;0;0(1;1),0;1;0(1;0)}, {0;1;0(1;0),1;1;0(0;0),1;0;0(0;1)}, "
      "{0;0;0(0;1),0;0;1(1;1),0;1;1(1;0)}, {0;1;1(1;0),0;1;0(0;0),0;0;0(0;1)}, "
      "{0;0;1(0;1),0;0;0(1;1),1;0;0(1;0)}, {1;0;0(1;0),1;0;1(0;0),0;0;1(0;1)}, "

      "{0;0;2(0;1),1;0;2(1;1),1;1;2(1;0)}, {1;1;2(1;0),0;1;2(0;0),0;0;2(0;1)}, "
      "{0;0;1(0;1),0;0;2(1;1),0;1;2(1;0)}, {0;1;2(1;0),0;1;1(0;0),0;0;1(0;1)}, "
      "{0;0;2(0;1),0;0;1(1;1),1;0;1(1;0)}, {1;0;1(1;0),1;0;2(0;0),0;0;2(0;1)}, "

      "{1;1;0(0;1),0;1;0(1;1),0;2;0(1;0)}, {0;2;0(1;0),1;2;0(0;0),1;1;0(0;1)}, "
      "{0;1;0(0;1),0;1;1(1;1),0;2;1(1;0)}, {0;2;1(1;0),0;2;0(0;0),0;1;0(0;1)}, "
      "{0;2;0(0;1),0;2;1(1;1),1;2;1(1;0)}, {1;2;1(1;0),1;2;0(0;0),0;2;0(0;1)}, "

      "{0;1;2(0;1),1;1;2(1;1),1;2;2(1;0)}, {1;2;2(1;0),0;2;2(0;0),0;1;2(0;1)}, "
      "{0;1;1(0;1),0;1;2(1;1),0;2;2(1;0)}, {0;2;2(1;0),0;2;1(0;0),0;1;1(0;1)}, "
      "{0;2;1(0;1),0;2;2(1;1),1;2;2(1;0)}, {1;2;2(1;0),1;2;1(0;0),0;2;1(0;1)}, "

      "{2;0;0(0;1),1;0;0(1;1),1;1;0(1;0)}, {1;1;0(1;0),2;1;0(0;0),2;0;0(0;1)}, "
      "{2;0;1(0;1),2;0;0(1;1),2;1;0(1;0)}, {2;1;0(1;0),2;1;1(0;0),2;0;1(0;1)}, "
      "{1;0;1(0;1),1;0;0(1;1),2;0;0(1;0)}, {2;0;0(1;0),2;0;1(0;0),1;0;1(0;1)}, "

      "{1;0;2(0;1),2;0;2(1;1),2;1;2(1;0)}, {2;1;2(1;0),1;1;2(0;0),1;0;2(0;1)}, "
      "{2;0;2(0;1),2;0;1(1;1),2;1;1(1;0)}, {2;1;1(1;0),2;1;2(0;0),2;0;2(0;1)}, "
      "{1;0;2(0;1),1;0;1(1;1),2;0;1(1;0)}, {2;0;1(1;0),2;0;2(0;0),1;0;2(0;1)}, "

      "{2;1;0(0;1),1;1;0(1;1),1;2;0(1;0)}, {1;2;0(1;0),2;2;0(0;0),2;1;0(0;1)}, "
      "{2;1;1(0;1),2;1;0(1;1),2;2;0(1;0)}, {2;2;0(1;0),2;2;1(0;0),2;1;1(0;1)}, "
      "{1;2;0(0;1),1;2;1(1;1),2;2;1(1;0)}, {2;2;1(1;0),2;2;0(0;0),1;2;0(0;1)}, "

      "{1;1;2(0;1),2;1;2(1;1),2;2;2(1;0)}, {2;2;2(1;0),1;2;2(0;0),1;1;2(0;1)}, "
      "{2;1;2(0;1),2;1;1(1;1),2;2;1(1;0)}, {2;2;1(1;0),2;2;2(0;0),2;1;2(0;1)}, "
      "{1;2;1(0;1),1;2;2(1;1),2;2;2(1;0)}, {2;2;2(1;0),2;2;1(0;0),1;2;1(0;1)}";
  EXPECT_EQ(toString(data), expected);
}
